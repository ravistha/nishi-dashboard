<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nunavut Community Index Dashboard</title>

    <!-- CDN Links -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Custom Scrollbar for the weight panel */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Accessing specific teal colors via standard CSS for inputs */
        input[type=range] {
            accent-color: #0C8CBE;
        }

        /* Custom Brand Classes */
        .bg-brand {
            background-color: #0C8CBE;
        }

        .text-brand {
            color: #0C8CBE;
        }

        .border-brand {
            border-color: #0C8CBE;
        }

        .from-brand {
            --tw-gradient-from: #0C8CBE;
        }

        .to-brand-dark {
            --tw-gradient-to: #086a91;
        }

        /* Darker shade for gradient */
    </style>
    <!-- Error Handler for Local Debugging -->
    <script>
        window.onerror = function (msg, url, line, col, error) {
            const statusEl = document.getElementById('connection-status');
            if (statusEl) {
                statusEl.textContent = "Script Error!";
                statusEl.className = "text-xs font-semibold text-red-600";
            }
            alert("Javascript Error:\n" + msg + "\n\nLine: " + line + "\n\nCheck console for details.");
            return false;
        };
    </script>
</head>

<body class="bg-gray-50 text-gray-800 font-sans">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="container mx-auto px-4 py-6">

            <!-- Top Row: Logos & Status -->
            <div class="flex justify-between items-center mb-6">
                <!-- Logos -->
                <div class="flex items-center gap-6">
                    <img src="images/logo_1.png" alt="Nunavut Tunngavik" class="h-16 w-auto object-contain">
                    <div class="h-10 w-px bg-gray-200 hidden md:block"></div>
                    <img src="images/logo_3.png" alt="NISHI" class="h-12 w-auto object-contain hidden md:block">
                </div>

                <!-- Right Side: Status + Partner Logo -->
                <div class="flex items-center gap-4">
                    <div id="connection-status" class="text-xs font-semibold text-gray-400">
                        Waiting for Script...
                    </div>
                    <img src="images/logo_2.png" alt="ACS AEC"
                        class="h-10 w-auto object-contain opacity-80 hover:opacity-100">
                </div>
            </div>

            <!-- Title & Description -->
            <div class="max-w-5xl">
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900 mb-4 tracking-tight">
                    Nunavut Inuit Sustainable Housing Index
                </h1>
                <p class="text-gray-600 leading-relaxed text-sm md:text-base border-l-4 border-brand pl-4">
                    This dashboard presents composite index scores for communities across Nunavut, summarizing community
                    conditions across five domains: Housing, Economic, Cultural, Health, and Social. Using the
                    indicators from the Indigenous Peoples Survey (2022 cycle) and Census 2021, the indices provide a
                    consistent way to compare patterns across communities and to track relative strengths and gaps
                    within each domain.
                    <br><br>
                    <span class="font-semibold text-brand">The higher the score, the better the performance.</span>
                </p>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- Controls Sidebar -->
        <aside class="lg:col-span-4 space-y-6">

            <!-- Community Selector -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <label class="block text-sm font-semibold text-brand mb-2">Select Community</label>
                <select id="community-select"
                    class="w-full p-3 bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-teal-500 focus:border-teal-500 block">
                    <!-- Options populated by data.js -->
                </select>

                <div class="mt-4 flex bg-gray-100 rounded-lg p-1">
                    <button id="btn-base"
                        class="flex-1 py-1 px-3 rounded-md text-sm font-medium transition-all bg-white shadow-sm text-brand flex items-center justify-center gap-2">
                        Base Scores
                        <i id="info-base" class="ph-bold ph-info hover:text-blue-800 cursor-pointer" title="Info"></i>
                    </button>
                    <button id="btn-adjusted"
                        class="flex-1 py-1 px-3 rounded-md text-sm font-medium text-gray-500 transition-all hover:text-gray-700 flex items-center justify-center gap-2">
                        Adjusted Model
                        <i id="info-adjusted" class="ph-bold ph-info hover:text-blue-800 cursor-pointer"
                            title="Info"></i>
                    </button>
                </div>

                <!-- Rank Toggle -->
                <button id="btn-toggle-view"
                    class="mt-3 w-full py-2 text-xs font-semibold text-brand hover:text-blue-800 underline decoration-dashed underline-offset-4">
                    See Ranks instead of Scores
                </button>
            </div>

            <!-- Info Modal -->
            <div id="info-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 animate-fade-in">
                    <div class="flex justify-between items-start mb-4">
                        <h3 id="modal-title" class="text-xl font-bold text-gray-900">Model Information</h3>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="ph-bold ph-x text-lg"></i>
                        </button>
                    </div>
                    <p id="modal-content" class="text-gray-600 leading-relaxed text-sm">
                        <!-- Content injected by JS -->
                    </p>
                    <div class="mt-6 flex justify-end">
                        <button onclick="closeModal()"
                            class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 font-medium text-sm">Close</button>
                    </div>
                </div>
            </div>

            <!-- Weighting Controls -->
            <div
                class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 max-h-[calc(100vh-250px)] overflow-y-auto scrollbar-hide">

                <!-- NEW: Instructions Block -->
                <div class="bg-blue-50 p-4 rounded-lg mb-6 border border-blue-100 text-sm text-brand">
                    <h3 class="font-bold mb-2 flex items-center gap-2">
                        <i class="ph ph-info"></i> How to Adjust Weights
                    </h3>
                    <ul class="list-disc list-inside space-y-1 text-xs opacity-90 text-gray-700">
                        <li><strong>Domains must sum to 100%</strong>. Use the sliders to adjust importance.</li>
                        <li><strong>Indicators must also sum to 100%</strong> within each domain.</li>
                        <li>Uncheck an indicator to <span class="font-bold">exclude</span> it completely.</li>
                        <li>The <span class="font-bold text-red-500">Red Text</span> will warn you if totals are off.
                        </li>
                    </ul>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800">Custom Weights</h2>
                    <button id="reset-weights" class="text-xs text-red-500 hover:underline">Reset Default</button>
                </div>

                <div id="weight-controls-container" class="space-y-6">
                    <!-- Dynamic weight controls generated here -->
                </div>
            </div>
        </aside>

        <!-- Main Dashboard Area -->
        <section class="lg:col-span-8 space-y-6">

            <!-- Top Score Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Left: Community Name -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 flex flex-col justify-center">
                    <p class="text-gray-500 text-sm font-medium uppercase tracking-wider mb-1">Selected Community</p>
                    <h2 id="community-name-display" class="text-3xl md:text-4xl font-bold text-gray-800 break-words">--
                    </h2>
                </div>

                <!-- Right: Overall Score (Moved) -->
                <div
                    class="bg-gradient-to-br from-[#0C8CBE] to-[#086a91] text-white p-6 rounded-xl shadow-lg relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex justify-between items-start">
                            <p class="text-white text-sm font-medium uppercase tracking-wider">Overall Index Score</p>
                            <span id="model-type-display"
                                class="text-xs bg-white/20 px-2 py-1 rounded text-white font-semibold">Base Model</span>
                        </div>
                        <h2 id="overall-score-display" class="text-5xl font-bold mt-2">--</h2>
                    </div>
                    <i
                        class="ph ph-trophy absolute -right-4 -bottom-4 text-9xl text-white opacity-20 transform rotate-12"></i>
                </div>
            </div>

            <!-- Main Domain Charts -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <h3 id="domain-chart-header" class="text-lg font-bold text-gray-800 mb-4">Domain Performance (vs
                    Average)</h3>
                <div class="h-64 md:h-80 relative">
                    <canvas id="main-radar-chart"></canvas>

                    <!-- Rank Table Container -->
                    <div id="rank-table-container"
                        class="hidden absolute inset-0 bg-white overflow-y-auto p-2 flex flex-col items-start">
                        <table class="w-auto text-left border-collapse ml-4">
                            <thead>
                                <tr class="border-b-2 border-slate-100">
                                    <th class="py-2 px-4 text-sm font-bold text-slate-500 uppercase tracking-wide">
                                        Domain
                                    </th>
                                    <th
                                        class="py-2 text-sm font-bold text-slate-500 text-right uppercase tracking-wide">
                                        Rank</th>
                                </tr>
                            </thead>
                            <tbody id="rank-table-body" class="text-sm"></tbody>
                        </table>
                        <p class="text-xs text-center text-gray-400 mt-4 italic">* Rank 1 is Best (Teal), Higher Rank is
                            Worse (Orange)</p>
                    </div>
                </div>
            </div>

            <!-- Comparison Section -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <h3 id="regional-chart-header" class="text-lg font-bold text-gray-800 mb-4">Regional Comparison</h3>
                <div class="h-64">
                    <canvas id="comparison-bar-chart"></canvas>
                </div>
            </div>

            <!-- NEW: Detailed Data Section -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <div class="flex justify-between items-center cursor-pointer" onclick="toggleDetailsTable()">
                    <h3 class="text-lg font-bold text-gray-800">Detailed Indicator Data</h3>
                    <button class="flex items-center gap-1 text-brand font-semibold text-sm hover:underline">
                        <span id="details-toggle-text">Show Data</span>
                        <i id="details-toggle-icon" class="ph ph-caret-down"></i>
                    </button>
                </div>
                <!-- Hidden by default -->
                <div id="details-table-container" class="hidden mt-6 overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                            <tr>
                                <th class="px-4 py-3">Domain</th>
                                <th class="px-4 py-3">Indicator</th>
                                <th class="px-4 py-3 text-right">Score</th>
                                <th class="px-4 py-3 text-right">Rank</th>
                                <th class="px-4 py-3 text-right">Weight Impact</th>
                            </tr>
                        </thead>
                        <tbody id="details-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

        </section>
    </main>

    <footer class="text-center py-6 text-gray-400 text-sm">
        <p>&copy; 2025 Nunavut Index Dashboard</p>
    </footer>

    <!-- Main Logic Inlined -->
    <!-- Main Logic Externalized -->
    <script src="app_v2.js"></script>
</body>

</html>